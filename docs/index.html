<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User-defined functions (UDF) in R on Earth observation data in cloud back-ends • openEO.R.UDF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="User-defined functions (UDF) in R on Earth observation data in cloud back-ends">
<meta property="og:description" content="Reads Earth Observation (EO) data to a stars object, applies users' custom function on it,
    and computes the results. This package is meant to be used by cloud back-ends compliant with the openEO API
    for user-defined functions (UDFs) and is interfaced with the help of file-based implementations and RESTful web services.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">openEO.R.UDF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="articles/openEO.R.UDF.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/file-based.html">File-based UDF service (Strategy 1)</a>
    </li>
    <li>
      <a href="articles/web-based_JSON.html">RESTful UDF service using JSON arrays (Strategies 2A &amp; 2B)</a>
    </li>
    <li>
      <a href="articles/web-based_base64.html">RESTful UDF service using base64 encoded string (Strategy 3)</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Open-EO/openeo-r-udf">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    

    
    
<div id="openeo-r-udf" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#openeo-r-udf" class="anchor"></a>openeo-r-udf</h1></div>
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This repository contains a R package for implementing the concept of User-Defined Functions for processing Earth Observation (EO) data in cloud backends. This will allow users to run their custom code written in R to be executed on EO data such as satellite imageries with the help of processing backends conforming to the openEO API. The openEO API is being developed as part of the project <a href="https://github.com/Open-EO">“openEO”</a>.</p>
<div id="background" class="section level3">
<h3 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h3>
<p>This repository is meant to be part of the H2020 funded project <a href="http://openeo.org">openEO</a>. The objective of this project is to develop an uniform API to allow processing of Earth Observation (EO) data in cloud-based processing backends from various client nodes. In this API framework, User-Defined Functions (UDFs) is a concept that would allow users to run their own scripts on EO data in these cloud backends.</p>
</div>
<div id="user-defined-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#user-defined-functions" class="anchor"></a>User-Defined Functions</h3>
<p>The UDFs are implemented by developing an UDF API which work hand-in-hand with the openEO core API. The main idea is that there are UDF (web-) services which could be used by the backends as required. The typical workflow is:</p>
<ol style="list-style-type: decimal">
<li>The user uploads his/her script from the client nodes to the backends along with the process graph</li>
<li>The backend executes the process graph and encounters the UDF in the process graph</li>
<li>The backend seeks the services of the UDF service to execute the user’s script and sends the script and intermediate data to the service through appropriate means (file-based service, RESTful web-service etc.)</li>
<li>The UDF service executes the script on the data and sends the result back to the backend.</li>
<li>The backend receives the data and continues executing the process graph until the final result is obtained.</li>
<li>The backend sends the completed result to the user’s client node.</li>
</ol>
<p>These UDF service is being developed for two different languages - Python and R. This repository concerns with the implementation using R.</p>
</div>
<div id="architecture" class="section level3">
<h3 class="hasAnchor">
<a href="#architecture" class="anchor"></a>Architecture</h3>
<p><img src="reference/figures/openeo_github.png" width="700px"></p>
<p>In the openEO API, the different clients interact with the different backends through the openEO API which acts as a common language understood by both the clients and the backends. The UDF service is not accessible to the clients directly but only through the backends and hence the UDF service’s internal operations are abstracted to the user.</p>
</div>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div id="dependencies" class="section level3">
<h3 class="hasAnchor">
<a href="#dependencies" class="anchor"></a>Dependencies</h3>
<p>This R package has the following dependencies * stars * jsonlite * plumber * raster * base64enc * zip</p>
<p>These can be installed by running the following:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"stars"</span>, <span class="st">"jsonlite"</span>, <span class="st">"plumber"</span>, <span class="st">"raster"</span>, <span class="st">"base64enc"</span>, <span class="st">"zip"</span>), <span class="dt">dependencies =</span> <span class="ot">TRUE</span>)</code></pre></div>
</div>
<div id="installing-openeo-r-udf" class="section level3">
<h3 class="hasAnchor">
<a href="#installing-openeo-r-udf" class="anchor"></a>Installing <code>openEO.R.UDF</code>
</h3>
<p>This package can then be installed using</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install_github</span>(<span class="st">"Open-EO/openeo-r-udf"</span>)</code></pre></div>
</div>
<div id="using-docker" class="section level3">
<h3 class="hasAnchor">
<a href="#using-docker" class="anchor"></a>Using Docker</h3>
<p>Docker provides a virtual containerized environment for running software. In order to install this R package in a Docker environment, please follow these steps:</p>
<ol style="list-style-type: decimal">
<li>Install Docker on your machine. The installation instructions vary according to the Operating System. Detailed instructions for all common Operating Systems may be found here: <a href="https://docs.docker.com/install/" class="uri">https://docs.docker.com/install/</a>.</li>
<li>
<p>Make sure that Docker has been installed correctly using the following command. Details on containers and Docker version will be shown.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> info</code></pre></div>
</li>
<li>
<p>Test whether installation using Docker is working correctly. A hello message should be printed on screen.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run hello-world</code></pre></div>
</li>
<li>
<p>Run it using the following command. If this image is not present on the local machine, it will be pulled from <a href="https://hub.docker.com/r/pramitghosh/openeo.r.udf/">Docker Hub</a>.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> run -p 5384:8010 pramitghosh/openeo.r.udf</code></pre></div>
<p>In the above command, <code>-p</code> re-routes the port where the service will be available. In the Docker image itself, this is available on port 8010. It can be mapped to any port of choice on the host (here it is mapped to port 5384). Instead of running, the image can be pulled from Docker Hub using</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> pull pramitghosh/openeo.r.udf</code></pre></div>
<h4 id="building-it-locally">Building it locally</h4>
<p>Once the source files are present on the local machine, running the following command (after navigating to the directory this repository is stored locally) builds a Docker image</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">docker</span> build -t openeo-r-udf -f DOCKERFILE .</code></pre></div>
</li>
</ol>
<div id="for-using-base64-encoded-string" class="section level4">
<h4 class="hasAnchor">
<a href="#for-using-base64-encoded-string" class="anchor"></a>For using base64 encoded string</h4>
<p>One of the strategies used involve transmission of data to and from the backend through HTTP POST requests in the form of base64 encoded strings representing a ZIP file containing generic GeoTIFFs embedded in a JSON. Please use the Docker container <code>pramitghosh/openeo.r.udf:wbin</code> on Docker Hub to use it. Currently, it is not possible to run it manually without encountering segmentation fault due to a long-standing issue in one of the dependencies of this package.</p>
</div>
</div>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<p>This package is intended to be used as part of the openEO API. The package works along with the different backends and are not supposed to accessible directly by the client. However, for testing, please refer to the the Wiki pages of this repository <a href="https://github.com/Open-EO/openeo-r-udf/wiki">here</a>.</p>
<div id="strategies" class="section level3">
<h3 class="hasAnchor">
<a href="#strategies" class="anchor"></a>Strategies</h3>
<p>This R package has implemented 4 strategies for the R UDF service. All of these involve converting the incoming data to a <code>stars</code> object before applying the UDF function. An overview of these strategies is shown in the figure below.</p>
<p><img src="reference/figures/strategies.png" width="700px"></p>
<ul>
<li>
<strong>Strategy 1</strong> implements the R UDF service as a part of the back-end with data being transmitted as binary GeoTIFF files along with a CSV file acting as a look-up table containing information on which image corresponds to which time, band etc. along with some additional information. These are converted to a <code>stars</code> object and exposed to the UDF as a list.</li>
<li>
<strong>Strategy 2A</strong> implements the R UDF service according to Soeren’s JSON schema. Backends send a POST request to a REST endpoint <code>/udf</code> with a body containing pixel values in nested JSON arrays. These are converted to a <code>stars</code> object and exposed to the UDF as a list.</li>
<li>
<strong>Strategy 2B</strong> also implements the R UDF service according to the same JSON schema as Strategy 2A, but instead of exposing the converted <code>stars</code> object as a list, it exposes it as it is. This runs at the endpoint <code>/udf/raw</code>
</li>
<li>
<strong>Strategy 3</strong> implements a REST endpoint at <code>/udf/binary</code> and exposes a <code>stars</code> object in a manner similar to Strategy 2B. In this strategy, the EO data in the form of GeoTIFF files are compressed into a ZIP file and its base64 encoded string representation is sent to the UDF service by the backend embedding it as a JSON in the POST body. The POST body also contains a look-up table, similar to Strategy 1, but in the form of JSON arrays.</li>
</ul>
</div>
<div id="performance" class="section level3">
<h3 class="hasAnchor">
<a href="#performance" class="anchor"></a>Performance</h3>
<p>Out of the strategies mentioned above, Strategy 1 is ultimately trivial since it does not offer a RESTful API. Therefore, although, faster than some of the other implementations, it is not practical in the context of openEO. Strategy 2A offers a REST interface, but as it exposes only a list of numbers (representing pixel values) to the UDF, the functionality of this strategy is limited to simple operations (e.g. aggregation over time, band etc.), similar to Strategy 1.</p>
<p>Strategy 2B exposes the whole <code>stars</code> object to the UDF, but as the EO data has to converted from ASCII JSON arrays from the incoming POST request to binary objects and reconverted to JSON arrays from binary objects while sending the response back, it is rather slow. Strategy 3 overcomes this limitation by sending the data as a base64 encoded string representing binary GeoTIFF files and offers a much faster turnaround time for running an UDF. Furthermore, this strategy allows users to install and use any R package (from Github, CRAN etc.) in his/her UDF and also load data from online sources, therefore allowing a lot of freedom and flexibility for the user. Now, auxilliary data in the form of files/directories can also be passed from the backend to the UDF service (for Strategy 3 only) by putting the data in a directory named <code>/data</code> in the ZIP file that is passed on as a base64 encoded string. These files are made available to the UDF script locally (in the same working directory).</p>
<p>Here are some test results for operations on a timeseries (3 timesteps with a temporal resolution of ~10 days) of spatially subsetted (300*300px) Sentinel-2 images containing 13 bands each illustrating the performance.</p>
<p>Aggregation over bands (using <code><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max()</a></code>) and time (using <code><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean()</a></code>) using Strategy 1 and 2A <img src="reference/figures/s1v2a.png" width="700px"></p>
<p>Reprojection (using <code><a href="https://www.rdocumentation.org/packages/stars/topics/st_warp">stars::st_warp()</a></code>) and Unsupervised Classification (using <code><a href="https://www.rdocumentation.org/packages/RStoolbox/topics/unsuperClass">RStoolbox::unsuperClass()</a></code>) using Strategy 2B and 3 <img src="reference/figures/s2bv3.png" width="700px"><img src="reference/figures/s_legend.jpeg" width="200px"></p>
<p>Further details regarding these strategies and their implementations may be found on these <a href="https://pramitghosh.github.io/slides/defense_25-1.html">slides</a> and in <a href="https://www.researchgate.net/publication/330533820_Running_user-defined_functions_in_R_on_Earth_observation_data_in_cloud_back-ends">Ghosh et al., 2018</a>.</p>
</div>
<div id="testing" class="section level3">
<h3 class="hasAnchor">
<a href="#testing" class="anchor"></a>Testing</h3>
<p>Examples of HTTP POST bodies (as JSONs) for strategies 2A, 2B and 3 can be found in <a href="https://github.com/pramitghosh/openeo-r-udf-examples">pramitghosh/openeo-r-udf-examples</a>. Manuals on how to do that is available on the Wiki.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/Open-EO/openeo-r-udf">https://​github.com/​Open-EO/​openeo-r-udf</a>
</li>
<li>Report a bug at <br><a href="https://github.com/Open-EO/openeo-r-udf/issues">https://​github.com/​Open-EO/​openeo-r-udf/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>Apache License</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Pramit Ghosh <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-1852-5951" target="orcid.widget"><img src="https://members.orcid.org/sites/default/files/vector_iD_icon.svg" class="orcid" alt="ORCID" height="16"></a> </li>
<li>Florian Lahn <br><small class="roles"> Author, contributor </small>  </li>
</ul>
</div>

      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Pramit Ghosh, Florian Lahn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
