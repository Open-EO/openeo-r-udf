<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>File-based UDF service (Strategy 1) • openEO.R.UDF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="File-based UDF service (Strategy 1)">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">openEO.R.UDF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/openEO.R.UDF.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/file-based.html">File-based UDF service (Strategy 1)</a>
    </li>
    <li>
      <a href="../articles/web-based_JSON.html">RESTful UDF service using JSON arrays (Strategies 2A &amp; 2B)</a>
    </li>
    <li>
      <a href="../articles/web-based_base64.html">RESTful UDF service using base64 encoded string</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pramitghosh/openEO.R.UDF">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>File-based UDF service (Strategy 1)</h1>
                        <h4 class="author">Pramit Ghosh</h4>
            
            <h4 class="date">2019-03-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pramitghosh/openEO.R.UDF/blob/master/vignettes/file-based.Rmd"><code>vignettes/file-based.Rmd</code></a></small>
      <div class="hidden name"><code>file-based.Rmd</code></div>

    </div>

    
    
<div id="introducing-the-file-based-r-udf-service" class="section level2">
<h2 class="hasAnchor">
<a href="#introducing-the-file-based-r-udf-service" class="anchor"></a>Introducing the file-based R UDF service</h2>
<div id="overview-of-strategy" class="section level3">
<h3 class="hasAnchor">
<a href="#overview-of-strategy" class="anchor"></a>Overview of Strategy</h3>
<p><img src="../man/figures/strategy_1.png" width="700px"></p>
</div>
<div id="background" class="section level3">
<h3 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h3>
<p>The file-based R UDF service works on the concept that it is possible to have a common storage space which is accessible feasibly by both the backends as well as the R UDF service. Then, when a UDF is encountered in the process graph by the backend, it writes the intermediate results to that disk in the form of generic GeoTIFF files along with a look-up table (in the form of a CSV file) which contains information on which file corresponds to which time-step and band along with some redundant information such as their spatial and temporal extents. Control is transferred to the user’s UDF script file which would then</p>
<ul>
<li><p>load this library using</p></li>
<li><p>define his/her custom function</p></li>
</ul>
<p>and pass the function name as an argument to the function <code><a href="../reference/run_UDF.html">run_UDF()</a></code> which is defined in the package <code>openEO.R.UDF</code>. Here <code>obj</code> is a list of numbers obtained from using <code>st_apply()</code> on a stars object with a <code>MAR</code> argument to define the dimension the function is to be applied on. For example,</p>
<p>Here, <code>legend_name</code> refers to the name of the look-up table and <code>drop_dim</code> refers to the dimension the function is to be applied over. <code>drop_dim = 3</code> refers to the dimension for <code>band</code> while <code>drop_dim = 4</code> refers to <code>time</code>.</p>
</div>
<div id="corresponding-r-backend" class="section level3">
<h3 class="hasAnchor">
<a href="#corresponding-r-backend" class="anchor"></a>Corresponding R “backend”</h3>
<p>This release shows the use of User Defined Functions (UDFs) in R in the context of the OpenEO project. OpenEO.R.UDF is a R package and currently integrates with the “backend” implementation by <span class="citation">@flahn</span> in R here: <a href="https://github.com/Open-EO/openeo-r-backend/" class="uri">https://github.com/Open-EO/openeo-r-backend/</a>.</p>
</div>
</div>
<div id="code-for-demo" class="section level2">
<h2 class="hasAnchor">
<a href="#code-for-demo" class="anchor"></a>Code for demo</h2>
<p>Working example:</p>
<ul>
<li>Install required packages Install the packages “openeo-r-backend”, “openeo” and “openEO.R.UDF”</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">     <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(devtools)
     <span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"Open-EO/openeo-r-backend"</span>, <span class="dt">ref =</span> <span class="st">"feature/udf_develop"</span>)
     <span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"Open-EO/openeo-r-client"</span>)
     <span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"pramitghosh/OpenEO.R.UDF"</span>)</code></pre></div>
<ul>
<li>Start the backend server and load demo data</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(openEO.R.Backend)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/openEO.R.Backend/topics/createServerInstance">createServerInstance</a></span>()
    openeo.server<span class="op">$</span>workspaces.path =<span class="st"> "&lt;path/to/workspace/directory here&gt;"</span>
    openeo.server<span class="op">$</span><span class="kw">initEnvironmentDefault</span>()
    openeo.server<span class="op">$</span><span class="kw">initializeDatabase</span>()

    <span class="co"># Creating a user for the first time...</span>
    <span class="co"># openeo.server$createUser(user_name = "&lt;username here&gt;", password = "&lt;password here&gt;")</span>

    openeo.server<span class="op">$</span><span class="kw">loadDemo</span>() <span class="co">#Loads demo data</span>
    openeo.server<span class="op">$</span><span class="kw">startup</span>(<span class="dt">port =</span> <span class="dv">8000</span>) <span class="co">#Starts up local server on port 8000</span></code></pre></div>
<ul>
<li>Login and execute process using the R client</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(openeo)
    conn =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/connect">connect</a></span>(<span class="dt">host =</span> <span class="st">"http://127.0.0.1:8000/api/"</span>, <span class="dt">user =</span> <span class="st">"&lt;registered username here&gt;"</span>, <span class="dt">password =</span> <span class="st">"&lt;password here&gt;"</span>, <span class="dt">rbackend =</span> T) <span class="co">#Login using credentials</span>
    conn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/listProcesses">listProcesses</a></span>() <span class="co">#Should show a list of available processes including `aggregate_time`</span>

    <span class="co"># Upload UDF script file in R to the server from the local working directory</span>
    <span class="co"># (e.g. &lt;https://github.com/pramitghosh/OpenEO.R.UDF/blob/master/data/example_udf/sample_udf.R&gt;)</span>
    <span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/uploadUserData">uploadUserData</a></span>(conn, <span class="dt">content =</span> <span class="st">"../backend/sample_udf.R"</span>, <span class="dt">target =</span> <span class="st">"/script.R"</span>)
    <span class="co">#Check to make sure the file "script.R" is listed to be present on the server</span>
    conn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/listFiles">listFiles</a></span>()

    <span class="co"># Create process graph starting with</span>
    <span class="co"># Sentinel-2 data -&gt; Temporal filtering -&gt; Applying UDF of type `aggregate_time` to find the median along the time axis for all the 13 bands</span>
    task =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/collection">collection</a></span>(<span class="st">"sentinel2_subset"</span>, <span class="dt">id_name =</span> <span class="st">"product_id"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/process">process</a></span>(<span class="dt">process_id =</span> <span class="st">"filter_daterange"</span>, <span class="dt">prior.name =</span> <span class="st">"imagery"</span>, <span class="dt">from =</span> <span class="st">"2017-05-01"</span>, <span class="dt">to =</span> <span class="st">"2017-06-20"</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openeo/topics/process">process</a></span>(<span class="dt">process_id =</span> <span class="st">"aggregate_time"</span>, <span class="dt">prior.name =</span> <span class="st">"imagery"</span>, <span class="dt">script =</span> <span class="st">"/script.R"</span>)
    conn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">executeTask</span>(<span class="dt">task =</span> task, <span class="dt">format =</span> <span class="st">"GTiff"</span>, <span class="dt">output_file =</span> <span class="st">"out.tif"</span>) <span class="co">#Executes the process graph</span></code></pre></div>
<p>The output file is to be found in the workspace directory that was defined. The end of processing could be observed when the message “Task result was sucessfully stored.” appears on the console running the client.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introducing-the-file-based-r-udf-service">Introducing the file-based R UDF service</a></li>
      <li><a href="#code-for-demo">Code for demo</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Pramit Ghosh, Florian Lahn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
